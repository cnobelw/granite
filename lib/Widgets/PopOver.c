/* PopOver.c generated by valac 0.36.7, the Vala compiler
 * generated from PopOver.vala, do not modify */

/***
    Copyright (C) 2011-2013 Lucas Baudin <xapantu@gmail.com>

    This program or library is free software; you can redistribute it
    and/or modify it under the terms of the GNU Lesser General Public
    License as published by the Free Software Foundation; either
    version 3 of the License, or (at your option) any later version.

    This library is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU
    Lesser General Public License for more details.
 
    You should have received a copy of the GNU Lesser General
    Public License along with this library; if not, write to the
    Free Software Foundation, Inc., 51 Franklin Street, Fifth Floor,
    Boston, MA 02110-1301 USA.
***/

#include <glib.h>
#include <glib-object.h>
#include <gtk/gtk.h>
#include <float.h>
#include <math.h>
#include <gdk/gdk.h>
#include <cairo.h>
#include <stdlib.h>
#include <string.h>


#define GRANITE_WIDGETS_TYPE_POP_OVER (granite_widgets_pop_over_get_type ())
#define GRANITE_WIDGETS_POP_OVER(obj) (G_TYPE_CHECK_INSTANCE_CAST ((obj), GRANITE_WIDGETS_TYPE_POP_OVER, GraniteWidgetsPopOver))
#define GRANITE_WIDGETS_POP_OVER_CLASS(klass) (G_TYPE_CHECK_CLASS_CAST ((klass), GRANITE_WIDGETS_TYPE_POP_OVER, GraniteWidgetsPopOverClass))
#define GRANITE_WIDGETS_IS_POP_OVER(obj) (G_TYPE_CHECK_INSTANCE_TYPE ((obj), GRANITE_WIDGETS_TYPE_POP_OVER))
#define GRANITE_WIDGETS_IS_POP_OVER_CLASS(klass) (G_TYPE_CHECK_CLASS_TYPE ((klass), GRANITE_WIDGETS_TYPE_POP_OVER))
#define GRANITE_WIDGETS_POP_OVER_GET_CLASS(obj) (G_TYPE_INSTANCE_GET_CLASS ((obj), GRANITE_WIDGETS_TYPE_POP_OVER, GraniteWidgetsPopOverClass))

typedef struct _GraniteWidgetsPopOver GraniteWidgetsPopOver;
typedef struct _GraniteWidgetsPopOverClass GraniteWidgetsPopOverClass;
typedef struct _GraniteWidgetsPopOverPrivate GraniteWidgetsPopOverPrivate;

#define GRANITE_DRAWING_TYPE_BUFFER_SURFACE (granite_drawing_buffer_surface_get_type ())
#define GRANITE_DRAWING_BUFFER_SURFACE(obj) (G_TYPE_CHECK_INSTANCE_CAST ((obj), GRANITE_DRAWING_TYPE_BUFFER_SURFACE, GraniteDrawingBufferSurface))
#define GRANITE_DRAWING_BUFFER_SURFACE_CLASS(klass) (G_TYPE_CHECK_CLASS_CAST ((klass), GRANITE_DRAWING_TYPE_BUFFER_SURFACE, GraniteDrawingBufferSurfaceClass))
#define GRANITE_DRAWING_IS_BUFFER_SURFACE(obj) (G_TYPE_CHECK_INSTANCE_TYPE ((obj), GRANITE_DRAWING_TYPE_BUFFER_SURFACE))
#define GRANITE_DRAWING_IS_BUFFER_SURFACE_CLASS(klass) (G_TYPE_CHECK_CLASS_TYPE ((klass), GRANITE_DRAWING_TYPE_BUFFER_SURFACE))
#define GRANITE_DRAWING_BUFFER_SURFACE_GET_CLASS(obj) (G_TYPE_INSTANCE_GET_CLASS ((obj), GRANITE_DRAWING_TYPE_BUFFER_SURFACE, GraniteDrawingBufferSurfaceClass))

typedef struct _GraniteDrawingBufferSurface GraniteDrawingBufferSurface;
typedef struct _GraniteDrawingBufferSurfaceClass GraniteDrawingBufferSurfaceClass;

#define GRANITE_WIDGETS_POP_OVER_TYPE_POP_POSITION (granite_widgets_pop_over_pop_position_get_type ())
#define _g_object_unref0(var) ((var == NULL) ? NULL : (var = (g_object_unref (var), NULL)))
#define _cairo_region_destroy0(var) ((var == NULL) ? NULL : (var = (cairo_region_destroy (var), NULL)))
#define _g_param_spec_unref0(var) ((var == NULL) ? NULL : (var = (g_param_spec_unref (var), NULL)))

struct _GraniteWidgetsPopOver {
	GtkDialog parent_instance;
	GraniteWidgetsPopOverPrivate * priv;
	gint BORDER_RADIUS;
	gint BORDER_WIDTH;
	gint SHADOW_SIZE;
	gint ARROW_HEIGHT;
	gint ARROW_WIDTH;
	GtkBorder PADDINGS;
	gboolean arrow_up;
	gdouble arrow_offset;
	GraniteDrawingBufferSurface* main_buffer;
};

struct _GraniteWidgetsPopOverClass {
	GtkDialogClass parent_class;
};

typedef enum  {
	GRANITE_WIDGETS_POP_OVER_POP_POSITION_NONE,
	GRANITE_WIDGETS_POP_OVER_POP_POSITION_TOPLEFT,
	GRANITE_WIDGETS_POP_OVER_POP_POSITION_TOPRIGHT,
	GRANITE_WIDGETS_POP_OVER_POP_POSITION_BOTTOMLEFT,
	GRANITE_WIDGETS_POP_OVER_POP_POSITION_BOTTOMRIGHT
} GraniteWidgetsPopOverPopPosition;

struct _GraniteWidgetsPopOverPrivate {
	gdouble offset;
	GtkWidget* menu;
	GtkBox* hbox;
	GtkBox* abox;
	GraniteWidgetsPopOverPopPosition pos;
	gboolean was_shown;
	gint win_x;
	gint win_y;
	gint old_w;
	gint old_h;
};


static gpointer granite_widgets_pop_over_parent_class = NULL;

GType granite_widgets_pop_over_get_type (void) G_GNUC_CONST;
GType granite_drawing_buffer_surface_get_type (void) G_GNUC_CONST;
GType granite_widgets_pop_over_pop_position_get_type (void) G_GNUC_CONST;
#define GRANITE_WIDGETS_POP_OVER_GET_PRIVATE(o) (G_TYPE_INSTANCE_GET_PRIVATE ((o), GRANITE_WIDGETS_TYPE_POP_OVER, GraniteWidgetsPopOverPrivate))
enum  {
	GRANITE_WIDGETS_POP_OVER_0_PROPERTY
};
#define GRANITE_WIDGETS_POP_OVER_MARGIN 12
#define GRANITE_WIDGETS_POP_OVER_POPOVER_STYLESHEET "\n" \
"        .composited {\n" \
"            background-color: rgba (0, 0, 0, 0.0);\n" \
"        }\n" \
"    "
GraniteWidgetsPopOver* granite_widgets_pop_over_new (void);
GraniteWidgetsPopOver* granite_widgets_pop_over_construct (GType object_type);
#define GRANITE_STYLE_CLASS_POPOVER_BG "popover_bg"
static void granite_widgets_pop_over_on_size_allocate (GraniteWidgetsPopOver* self, GtkAllocation* alloc);
static void _granite_widgets_pop_over_on_size_allocate_gtk_widget_size_allocate (GtkWidget* _sender, GtkAllocation* allocation, gpointer self);
static gboolean __lambda69_ (GraniteWidgetsPopOver* self);
static gboolean ___lambda69__gtk_widget_grab_broken_event (GtkWidget* _sender, GdkEventGrabBroken* event, gpointer self);
static void __lambda70_ (GraniteWidgetsPopOver* self, gboolean was_grabbed);
static void ___lambda70__gtk_widget_grab_notify (GtkWidget* _sender, gboolean was_grabbed, gpointer self);
static void granite_widgets_pop_over_real_hide (GtkWidget* base);
static void granite_widgets_pop_over_real_show (GtkWidget* base);
static gboolean granite_widgets_pop_over_real_map_event (GtkWidget* base, GdkEventAny* event);
static gboolean granite_widgets_pop_over_real_button_press_event (GtkWidget* base, GdkEventButton* event);
static gboolean granite_widgets_pop_over_event_in_window (GraniteWidgetsPopOver* self, GdkEventButton* event);
static gboolean granite_widgets_pop_over_real_button_release_event (GtkWidget* base, GdkEventButton* event);
void granite_widgets_pop_over_reset_buffers (GraniteWidgetsPopOver* self);
void granite_widgets_pop_over_set_parent_pop (GraniteWidgetsPopOver* self, GtkWindow* win);
static gboolean __lambda71_ (GraniteWidgetsPopOver* self);
static gboolean ___lambda71__gtk_widget_configure_event (GtkWidget* _sender, GdkEventConfigure* event, gpointer self);
static void granite_widgets_pop_over_compute_pop_position (GraniteWidgetsPopOver* self, GdkScreen* screen, GdkRectangle* rect);
static void granite_widgets_pop_over_compute_shadow (GraniteWidgetsPopOver* self, gint w, gint h);
void granite_widgets_pop_over_move_to_widget (GraniteWidgetsPopOver* self, GtkWidget* w, gboolean show);
void granite_widgets_pop_over_move_to_coords (GraniteWidgetsPopOver* self, gint x, gint y, gboolean show);
void granite_widgets_pop_over_move_to_rect (GraniteWidgetsPopOver* self, GdkRectangle* rect, gboolean show);
void granite_widgets_pop_over_move_to_window (GraniteWidgetsPopOver* self, GdkWindow* window);
void granite_widgets_pop_over_cairo_popover (GraniteWidgetsPopOver* self, cairo_t* cr, gdouble x, gdouble y, gdouble width, gdouble height, gdouble border_radius);
GraniteDrawingBufferSurface* granite_drawing_buffer_surface_new (gint width, gint height);
GraniteDrawingBufferSurface* granite_drawing_buffer_surface_construct (GType object_type, gint width, gint height);
cairo_t* granite_drawing_buffer_surface_get_context (GraniteDrawingBufferSurface* self);
void granite_drawing_buffer_surface_exponential_blur (GraniteDrawingBufferSurface* self, gint radius);
static gboolean granite_widgets_pop_over_real_draw (GtkWidget* base, cairo_t* cr);
cairo_surface_t* granite_drawing_buffer_surface_get_surface (GraniteDrawingBufferSurface* self);
static GObject * granite_widgets_pop_over_constructor (GType type, guint n_construct_properties, GObjectConstructParam * construct_properties);
#define GRANITE_STYLE_CLASS_POPOVER "popover"
#define GRANITE_STYLE_CLASS_COMPOSITED "composited"
GtkCssProvider* granite_widgets_utils_set_theming_for_screen (GdkScreen* screen, const gchar* stylesheet, gint priority);
static void granite_widgets_pop_over_finalize (GObject * obj);


/**
     * Location of small triangle of popover
     */
GType granite_widgets_pop_over_pop_position_get_type (void) {
	static volatile gsize granite_widgets_pop_over_pop_position_type_id__volatile = 0;
	if (g_once_init_enter (&granite_widgets_pop_over_pop_position_type_id__volatile)) {
		static const GEnumValue values[] = {{GRANITE_WIDGETS_POP_OVER_POP_POSITION_NONE, "GRANITE_WIDGETS_POP_OVER_POP_POSITION_NONE", "none"}, {GRANITE_WIDGETS_POP_OVER_POP_POSITION_TOPLEFT, "GRANITE_WIDGETS_POP_OVER_POP_POSITION_TOPLEFT", "topleft"}, {GRANITE_WIDGETS_POP_OVER_POP_POSITION_TOPRIGHT, "GRANITE_WIDGETS_POP_OVER_POP_POSITION_TOPRIGHT", "topright"}, {GRANITE_WIDGETS_POP_OVER_POP_POSITION_BOTTOMLEFT, "GRANITE_WIDGETS_POP_OVER_POP_POSITION_BOTTOMLEFT", "bottomleft"}, {GRANITE_WIDGETS_POP_OVER_POP_POSITION_BOTTOMRIGHT, "GRANITE_WIDGETS_POP_OVER_POP_POSITION_BOTTOMRIGHT", "bottomright"}, {0, NULL, NULL}};
		GType granite_widgets_pop_over_pop_position_type_id;
		granite_widgets_pop_over_pop_position_type_id = g_enum_register_static ("GraniteWidgetsPopOverPopPosition", values);
		g_once_init_leave (&granite_widgets_pop_over_pop_position_type_id__volatile, granite_widgets_pop_over_pop_position_type_id);
	}
	return granite_widgets_pop_over_pop_position_type_id__volatile;
}


/**
     * Create a new PopOver
     */
static gpointer _g_object_ref0 (gpointer self) {
	return self ? g_object_ref (self) : NULL;
}


static void _granite_widgets_pop_over_on_size_allocate_gtk_widget_size_allocate (GtkWidget* _sender, GtkAllocation* allocation, gpointer self) {
	granite_widgets_pop_over_on_size_allocate ((GraniteWidgetsPopOver*) self, allocation);
}


static gboolean __lambda69_ (GraniteWidgetsPopOver* self) {
	gboolean result = FALSE;
	GTK_WIDGET_CLASS (granite_widgets_pop_over_parent_class)->hide ((GtkWidget*) G_TYPE_CHECK_INSTANCE_CAST (self, gtk_dialog_get_type (), GtkDialog));
	result = FALSE;
	return result;
}


static gboolean ___lambda69__gtk_widget_grab_broken_event (GtkWidget* _sender, GdkEventGrabBroken* event, gpointer self) {
	gboolean result;
	result = __lambda69_ ((GraniteWidgetsPopOver*) self);
	return result;
}


static void __lambda70_ (GraniteWidgetsPopOver* self, gboolean was_grabbed) {
	gboolean _tmp0_ = FALSE;
	gboolean _tmp1_;
	GdkDevice* pointer = NULL;
	GdkDisplay* _tmp3_;
	GdkDeviceManager* _tmp4_;
	GdkDevice* _tmp5_;
	GdkDevice* _tmp6_;
	GdkDevice* _tmp7_;
	GdkDevice* _tmp8_;
	_tmp1_ = self->priv->was_shown;
	if (!_tmp1_) {
		_tmp0_ = TRUE;
	} else {
		gboolean _tmp2_;
		_tmp2_ = was_grabbed;
		_tmp0_ = !_tmp2_;
	}
	if (_tmp0_) {
		return;
	}
	_tmp3_ = gdk_display_get_default ();
	_tmp4_ = gdk_display_get_device_manager (_tmp3_);
	_tmp5_ = gdk_device_manager_get_client_pointer (_tmp4_);
	_tmp6_ = _g_object_ref0 (_tmp5_);
	pointer = _tmp6_;
	_tmp7_ = pointer;
	gtk_device_grab_remove ((GtkWidget*) self, _tmp7_);
	_tmp8_ = pointer;
	gdk_device_ungrab (_tmp8_, (guint32) GDK_CURRENT_TIME);
	_g_object_unref0 (pointer);
}


static void ___lambda70__gtk_widget_grab_notify (GtkWidget* _sender, gboolean was_grabbed, gpointer self) {
	__lambda70_ ((GraniteWidgetsPopOver*) self, was_grabbed);
}


GraniteWidgetsPopOver* granite_widgets_pop_over_construct (GType object_type) {
	GraniteWidgetsPopOver * self = NULL;
	GtkBox* _tmp0_;
	GtkBox* _tmp1_;
	GtkWidget* _tmp2_;
	GtkBox* _tmp3_;
	GtkWindow* _tmp4_;
	GtkStyleContext* _tmp5_;
	GtkBorder _tmp6_ = {0};
	GtkBox* _tmp7_;
	GtkBorder _tmp8_;
	gint16 _tmp9_;
	gint _tmp10_;
	gint _tmp11_;
	GtkBox* _tmp12_;
	GtkBorder _tmp13_;
	gint16 _tmp14_;
	gint _tmp15_;
	GtkBox* _tmp16_;
	GtkBorder _tmp17_;
	gint16 _tmp18_;
	gint _tmp19_;
	GtkBox* _tmp20_;
	GtkBorder _tmp21_;
	gint16 _tmp22_;
	gint _tmp23_;
	GtkBox* _tmp24_;
	GtkBorder _tmp25_;
	gint16 _tmp26_;
	gint _tmp27_;
	GtkBox* _tmp28_;
	GtkBorder _tmp29_;
	gint16 _tmp30_;
	gint _tmp31_;
	GtkWidget* _tmp32_;
	GtkStyleContext* _tmp33_;
	self = (GraniteWidgetsPopOver*) g_object_new (object_type, NULL);
	gtk_window_set_modal ((GtkWindow*) self, TRUE);
	gtk_window_set_role ((GtkWindow*) self, "popover");
	_tmp0_ = (GtkBox*) gtk_dialog_get_content_area ((GtkDialog*) self);
	_tmp1_ = _g_object_ref0 (G_TYPE_CHECK_INSTANCE_TYPE (_tmp0_, gtk_box_get_type ()) ? ((GtkBox*) _tmp0_) : NULL);
	_g_object_unref0 (self->priv->hbox);
	self->priv->hbox = _tmp1_;
	_tmp2_ = gtk_dialog_get_action_area ((GtkDialog*) self);
	_tmp3_ = _g_object_ref0 (G_TYPE_CHECK_INSTANCE_TYPE (_tmp2_, gtk_box_get_type ()) ? ((GtkBox*) _tmp2_) : NULL);
	_g_object_unref0 (self->priv->abox);
	self->priv->abox = _tmp3_;
	_tmp4_ = (GtkWindow*) gtk_window_new (GTK_WINDOW_TOPLEVEL);
	g_object_ref_sink (_tmp4_);
	_g_object_unref0 (self->priv->menu);
	self->priv->menu = (GtkWidget*) _tmp4_;
	gtk_widget_style_get ((GtkWidget*) self, "border-radius", &self->BORDER_RADIUS, "border-width", &self->BORDER_WIDTH, "shadow-size", &self->SHADOW_SIZE, "arrow-height", &self->ARROW_HEIGHT, "arrow_width", &self->ARROW_WIDTH, NULL, NULL);
	_tmp5_ = gtk_widget_get_style_context ((GtkWidget*) self);
	gtk_style_context_get_margin (_tmp5_, GTK_STATE_FLAG_NORMAL, &_tmp6_);
	self->PADDINGS = _tmp6_;
	_tmp7_ = self->priv->hbox;
	_tmp8_ = self->PADDINGS;
	_tmp9_ = _tmp8_.top;
	_tmp10_ = self->ARROW_HEIGHT;
	_tmp11_ = self->SHADOW_SIZE;
	gtk_widget_set_margin_top ((GtkWidget*) _tmp7_, ((_tmp9_ + _tmp10_) + _tmp11_) + 5);
	_tmp12_ = self->priv->hbox;
	_tmp13_ = self->PADDINGS;
	_tmp14_ = _tmp13_.left;
	_tmp15_ = self->SHADOW_SIZE;
	gtk_widget_set_margin_left ((GtkWidget*) _tmp12_, (_tmp14_ + _tmp15_) + 5);
	_tmp16_ = self->priv->hbox;
	_tmp17_ = self->PADDINGS;
	_tmp18_ = _tmp17_.right;
	_tmp19_ = self->SHADOW_SIZE;
	gtk_widget_set_margin_right ((GtkWidget*) _tmp16_, (_tmp18_ + _tmp19_) + 5);
	_tmp20_ = self->priv->abox;
	_tmp21_ = self->PADDINGS;
	_tmp22_ = _tmp21_.left;
	_tmp23_ = self->SHADOW_SIZE;
	gtk_widget_set_margin_left ((GtkWidget*) _tmp20_, (_tmp22_ + _tmp23_) + 5);
	_tmp24_ = self->priv->abox;
	_tmp25_ = self->PADDINGS;
	_tmp26_ = _tmp25_.right;
	_tmp27_ = self->SHADOW_SIZE;
	gtk_widget_set_margin_right ((GtkWidget*) _tmp24_, (_tmp26_ + _tmp27_) + 5);
	_tmp28_ = self->priv->abox;
	_tmp29_ = self->PADDINGS;
	_tmp30_ = _tmp29_.bottom;
	_tmp31_ = self->SHADOW_SIZE;
	gtk_widget_set_margin_bottom ((GtkWidget*) _tmp28_, (_tmp30_ + _tmp31_) + 5);
	_tmp32_ = self->priv->menu;
	_tmp33_ = gtk_widget_get_style_context (_tmp32_);
	gtk_style_context_add_class (_tmp33_, GRANITE_STYLE_CLASS_POPOVER_BG);
	g_signal_connect_object ((GtkWidget*) self, "size-allocate", (GCallback) _granite_widgets_pop_over_on_size_allocate_gtk_widget_size_allocate, self, 0);
	g_signal_connect_object ((GtkWidget*) self, "grab-broken-event", (GCallback) ___lambda69__gtk_widget_grab_broken_event, self, 0);
	g_signal_connect_object ((GtkWidget*) self, "grab-notify", (GCallback) ___lambda70__gtk_widget_grab_notify, self, 0);
	return self;
}


GraniteWidgetsPopOver* granite_widgets_pop_over_new (void) {
	return granite_widgets_pop_over_construct (GRANITE_WIDGETS_TYPE_POP_OVER);
}


/**
    * Hides popover
    */
static void granite_widgets_pop_over_real_hide (GtkWidget* base) {
	GraniteWidgetsPopOver * self;
	GdkDevice* pointer = NULL;
	GdkDisplay* _tmp0_;
	GdkDeviceManager* _tmp1_;
	GdkDevice* _tmp2_;
	GdkDevice* _tmp3_;
	self = (GraniteWidgetsPopOver*) base;
	_tmp0_ = gdk_display_get_default ();
	_tmp1_ = gdk_display_get_device_manager (_tmp0_);
	_tmp2_ = gdk_device_manager_get_client_pointer (_tmp1_);
	_tmp3_ = _g_object_ref0 (_tmp2_);
	pointer = _tmp3_;
	gtk_device_grab_remove ((GtkWidget*) self, pointer);
	gdk_device_ungrab (pointer, (guint32) GDK_CURRENT_TIME);
	self->priv->was_shown = FALSE;
	GTK_WIDGET_CLASS (granite_widgets_pop_over_parent_class)->hide ((GtkWidget*) G_TYPE_CHECK_INSTANCE_CAST (self, gtk_dialog_get_type (), GtkDialog));
	_g_object_unref0 (pointer);
}


static void granite_widgets_pop_over_real_show (GtkWidget* base) {
	GraniteWidgetsPopOver * self;
	self = (GraniteWidgetsPopOver*) base;
	self->priv->was_shown = TRUE;
	GTK_WIDGET_CLASS (granite_widgets_pop_over_parent_class)->show ((GtkWidget*) G_TYPE_CHECK_INSTANCE_CAST (self, gtk_dialog_get_type (), GtkDialog));
}


/**
    * Grabs focus
    * 
    * @return false
    */
static gboolean granite_widgets_pop_over_real_map_event (GtkWidget* base, GdkEventAny* event) {
	GraniteWidgetsPopOver * self;
	gboolean result = FALSE;
	GdkDevice* pointer = NULL;
	GdkDisplay* _tmp0_;
	GdkDeviceManager* _tmp1_;
	GdkDevice* _tmp2_;
	GdkDevice* _tmp3_;
	GdkWindow* _tmp4_;
	self = (GraniteWidgetsPopOver*) base;
	g_return_val_if_fail (event != NULL, FALSE);
	_tmp0_ = gdk_display_get_default ();
	_tmp1_ = gdk_display_get_device_manager (_tmp0_);
	_tmp2_ = gdk_device_manager_get_client_pointer (_tmp1_);
	_tmp3_ = _g_object_ref0 (_tmp2_);
	pointer = _tmp3_;
	_tmp4_ = gtk_widget_get_window ((GtkWidget*) self);
	gdk_device_grab (pointer, _tmp4_, GDK_OWNERSHIP_NONE, TRUE, ((((GDK_SMOOTH_SCROLL_MASK | GDK_BUTTON_PRESS_MASK) | GDK_BUTTON_RELEASE_MASK) | GDK_ENTER_NOTIFY_MASK) | GDK_LEAVE_NOTIFY_MASK) | GDK_POINTER_MOTION_MASK, NULL, (guint32) GDK_CURRENT_TIME);
	gtk_device_grab_add ((GtkWidget*) self, pointer, FALSE);
	result = FALSE;
	_g_object_unref0 (pointer);
	return result;
}


static gboolean granite_widgets_pop_over_real_button_press_event (GtkWidget* base, GdkEventButton* event) {
	GraniteWidgetsPopOver * self;
	gboolean result = FALSE;
	GdkEventButton* _tmp0_;
	gboolean _tmp1_;
	GdkEventButton* _tmp2_;
	gboolean _tmp3_;
	self = (GraniteWidgetsPopOver*) base;
	g_return_val_if_fail (event != NULL, FALSE);
	_tmp0_ = event;
	_tmp1_ = granite_widgets_pop_over_event_in_window (self, _tmp0_);
	if (_tmp1_) {
		result = TRUE;
		return result;
	}
	_tmp2_ = event;
	_tmp3_ = GTK_WIDGET_CLASS (granite_widgets_pop_over_parent_class)->button_press_event ((GtkWidget*) G_TYPE_CHECK_INSTANCE_CAST (self, gtk_dialog_get_type (), GtkDialog), _tmp2_);
	result = _tmp3_;
	return result;
}


static gboolean granite_widgets_pop_over_real_button_release_event (GtkWidget* base, GdkEventButton* event) {
	GraniteWidgetsPopOver * self;
	gboolean result = FALSE;
	GdkEventButton* _tmp0_;
	gboolean _tmp1_;
	self = (GraniteWidgetsPopOver*) base;
	g_return_val_if_fail (event != NULL, FALSE);
	_tmp0_ = event;
	_tmp1_ = granite_widgets_pop_over_event_in_window (self, _tmp0_);
	if (_tmp1_) {
		result = TRUE;
		return result;
	}
	gtk_widget_hide ((GtkWidget*) self);
	result = FALSE;
	return result;
}


static gboolean granite_widgets_pop_over_event_in_window (GraniteWidgetsPopOver* self, GdkEventButton* event) {
	gboolean result = FALSE;
	gint x = 0;
	gint y = 0;
	gint w = 0;
	gint h = 0;
	gint _tmp0_ = 0;
	gint _tmp1_ = 0;
	gint _tmp2_ = 0;
	gint _tmp3_ = 0;
	gboolean _tmp4_ = FALSE;
	gboolean _tmp5_ = FALSE;
	gboolean _tmp6_ = FALSE;
	GdkEventButton* _tmp7_;
	gdouble _tmp8_;
	gint _tmp9_;
	g_return_val_if_fail (self != NULL, FALSE);
	g_return_val_if_fail (event != NULL, FALSE);
	gtk_window_get_position ((GtkWindow*) self, &_tmp0_, &_tmp1_);
	x = _tmp0_;
	y = _tmp1_;
	gtk_window_get_size ((GtkWindow*) self, &_tmp2_, &_tmp3_);
	w = _tmp2_;
	h = _tmp3_;
	_tmp7_ = event;
	_tmp8_ = _tmp7_->x_root;
	_tmp9_ = x;
	if (_tmp8_ >= ((gdouble) _tmp9_)) {
		GdkEventButton* _tmp10_;
		gdouble _tmp11_;
		gint _tmp12_;
		gint _tmp13_;
		_tmp10_ = event;
		_tmp11_ = _tmp10_->x_root;
		_tmp12_ = x;
		_tmp13_ = w;
		_tmp6_ = _tmp11_ <= ((gdouble) (_tmp12_ + _tmp13_));
	} else {
		_tmp6_ = FALSE;
	}
	if (_tmp6_) {
		GdkEventButton* _tmp14_;
		gdouble _tmp15_;
		gint _tmp16_;
		_tmp14_ = event;
		_tmp15_ = _tmp14_->y_root;
		_tmp16_ = y;
		_tmp5_ = _tmp15_ >= ((gdouble) _tmp16_);
	} else {
		_tmp5_ = FALSE;
	}
	if (_tmp5_) {
		GdkEventButton* _tmp17_;
		gdouble _tmp18_;
		gint _tmp19_;
		gint _tmp20_;
		_tmp17_ = event;
		_tmp18_ = _tmp17_->y_root;
		_tmp19_ = y;
		_tmp20_ = h;
		_tmp4_ = _tmp18_ <= ((gdouble) (_tmp19_ + _tmp20_));
	} else {
		_tmp4_ = FALSE;
	}
	result = _tmp4_;
	return result;
}


void granite_widgets_pop_over_reset_buffers (GraniteWidgetsPopOver* self) {
	g_return_if_fail (self != NULL);
	_g_object_unref0 (self->main_buffer);
	self->main_buffer = NULL;
}


/**
     * Set the parent window of the popover. It should not be needed, but it
     * could solve some bugs on some window manager.
     */
static gboolean __lambda71_ (GraniteWidgetsPopOver* self) {
	gboolean result = FALSE;
	gtk_widget_hide ((GtkWidget*) self);
	result = TRUE;
	return result;
}


static gboolean ___lambda71__gtk_widget_configure_event (GtkWidget* _sender, GdkEventConfigure* event, gpointer self) {
	gboolean result;
	result = __lambda71_ ((GraniteWidgetsPopOver*) self);
	return result;
}


void granite_widgets_pop_over_set_parent_pop (GraniteWidgetsPopOver* self, GtkWindow* win) {
	GtkWindow* _tmp0_;
	GtkWindow* _tmp1_;
	GtkWindow* _tmp2_;
	g_return_if_fail (self != NULL);
	g_return_if_fail (win != NULL);
	_tmp0_ = win;
	gtk_window_set_transient_for ((GtkWindow*) self, _tmp0_);
	_tmp1_ = win;
	gtk_widget_set_parent ((GtkWidget*) self, (GtkWidget*) ((GtkContainer*) _tmp1_));
	_tmp2_ = win;
	g_signal_connect_object ((GtkWidget*) _tmp2_, "configure-event", (GCallback) ___lambda71__gtk_widget_configure_event, self, 0);
}


static void granite_widgets_pop_over_compute_pop_position (GraniteWidgetsPopOver* self, GdkScreen* screen, GdkRectangle* rect) {
	GdkRectangle monitor_geo = {0};
	GraniteWidgetsPopOverPopPosition old_pos = 0;
	GraniteWidgetsPopOverPopPosition _tmp0_;
	GdkScreen* _tmp1_;
	GdkScreen* _tmp2_;
	GdkRectangle _tmp3_;
	gint _tmp4_;
	GdkRectangle _tmp5_;
	gint _tmp6_;
	gint _tmp7_;
	GdkRectangle _tmp8_ = {0};
	GdkRectangle _tmp9_;
	gint _tmp10_;
	GdkRectangle _tmp11_;
	gint _tmp12_;
	GdkRectangle _tmp13_;
	gint _tmp14_;
	GraniteWidgetsPopOverPopPosition _tmp27_;
	gboolean _tmp78_;
	GraniteWidgetsPopOverPopPosition _tmp97_;
	GraniteWidgetsPopOverPopPosition _tmp98_;
	gint w = 0;
	gint _tmp101_;
	gint h = 0;
	gint _tmp102_;
	gint _tmp103_;
	GtkBorder _tmp104_;
	gint16 _tmp105_;
	gint _tmp106_;
	gint _tmp107_;
	gint _tmp108_;
	GtkBorder _tmp109_;
	gint16 _tmp110_;
	gint _tmp111_;
	gint _tmp112_ = 0;
	gboolean _tmp113_;
	GdkWindow* _tmp115_;
	gint _tmp116_;
	gint _tmp117_;
	cairo_rectangle_int_t _tmp118_ = {0};
	cairo_region_t* _tmp119_;
	cairo_region_t* _tmp120_;
	GtkBorder _tmp121_;
	gint16 _tmp122_;
	gint _tmp123_;
	GtkBorder _tmp124_;
	gint16 _tmp125_;
	gint _tmp126_;
	g_return_if_fail (self != NULL);
	g_return_if_fail (screen != NULL);
	g_return_if_fail (rect != NULL);
	_tmp0_ = self->priv->pos;
	old_pos = _tmp0_;
	_tmp1_ = screen;
	_tmp2_ = screen;
	_tmp3_ = *rect;
	_tmp4_ = _tmp3_.x;
	_tmp5_ = *rect;
	_tmp6_ = _tmp5_.y;
	_tmp7_ = gdk_screen_get_monitor_at_point (_tmp2_, _tmp4_, _tmp6_);
	gdk_screen_get_monitor_geometry (_tmp1_, _tmp7_, &_tmp8_);
	monitor_geo = _tmp8_;
	_tmp9_ = *rect;
	_tmp10_ = _tmp9_.x;
	_tmp11_ = monitor_geo;
	_tmp12_ = _tmp11_.x;
	_tmp13_ = monitor_geo;
	_tmp14_ = _tmp13_.width;
	if (_tmp10_ > (_tmp12_ + (_tmp14_ / 2))) {
		GdkRectangle _tmp15_;
		gint _tmp16_;
		GdkRectangle _tmp17_;
		gint _tmp18_;
		GdkRectangle _tmp19_;
		gint _tmp20_;
		_tmp15_ = *rect;
		_tmp16_ = _tmp15_.y;
		_tmp17_ = monitor_geo;
		_tmp18_ = _tmp17_.y;
		_tmp19_ = monitor_geo;
		_tmp20_ = _tmp19_.height;
		if (_tmp16_ < (_tmp18_ + (_tmp20_ / 2))) {
			self->priv->pos = GRANITE_WIDGETS_POP_OVER_POP_POSITION_TOPRIGHT;
		} else {
			self->priv->pos = GRANITE_WIDGETS_POP_OVER_POP_POSITION_BOTTOMRIGHT;
		}
	} else {
		GdkRectangle _tmp21_;
		gint _tmp22_;
		GdkRectangle _tmp23_;
		gint _tmp24_;
		GdkRectangle _tmp25_;
		gint _tmp26_;
		_tmp21_ = *rect;
		_tmp22_ = _tmp21_.y;
		_tmp23_ = monitor_geo;
		_tmp24_ = _tmp23_.y;
		_tmp25_ = monitor_geo;
		_tmp26_ = _tmp25_.height;
		if (_tmp22_ < (_tmp24_ + (_tmp26_ / 2))) {
			self->priv->pos = GRANITE_WIDGETS_POP_OVER_POP_POSITION_TOPLEFT;
		} else {
			self->priv->pos = GRANITE_WIDGETS_POP_OVER_POP_POSITION_BOTTOMLEFT;
		}
	}
	_tmp27_ = self->priv->pos;
	switch (_tmp27_) {
		case GRANITE_WIDGETS_POP_OVER_POP_POSITION_BOTTOMRIGHT:
		{
			GdkRectangle _tmp28_;
			gint _tmp29_;
			gint _tmp30_;
			gint _tmp31_;
			gint _tmp32_;
			GdkRectangle _tmp33_;
			gint _tmp34_;
			GdkRectangle _tmp35_;
			gint _tmp36_;
			gint _tmp37_;
			gint _tmp38_;
			gint _tmp39_;
			gint _tmp40_;
			self->arrow_up = FALSE;
			_tmp28_ = *rect;
			_tmp29_ = _tmp28_.x;
			_tmp30_ = gtk_widget_get_allocated_width ((GtkWidget*) self);
			_tmp31_ = self->SHADOW_SIZE;
			_tmp32_ = self->ARROW_WIDTH;
			_tmp33_ = *rect;
			_tmp34_ = _tmp33_.width;
			self->priv->win_x = (((_tmp29_ - _tmp30_) + (2 * _tmp31_)) + (_tmp32_ / 2)) + (_tmp34_ / 2);
			_tmp35_ = *rect;
			_tmp36_ = _tmp35_.y;
			_tmp37_ = gtk_widget_get_allocated_height ((GtkWidget*) self);
			_tmp38_ = self->SHADOW_SIZE;
			self->priv->win_y = (_tmp36_ - _tmp37_) + _tmp38_;
			_tmp39_ = gtk_widget_get_allocated_width ((GtkWidget*) self);
			_tmp40_ = self->SHADOW_SIZE;
			self->arrow_offset = (_tmp39_ - (2 * _tmp40_)) - 30.0;
			break;
		}
		case GRANITE_WIDGETS_POP_OVER_POP_POSITION_TOPRIGHT:
		{
			GdkRectangle _tmp41_;
			gint _tmp42_;
			gint _tmp43_;
			gint _tmp44_;
			gint _tmp45_;
			GdkRectangle _tmp46_;
			gint _tmp47_;
			GdkRectangle _tmp48_;
			gint _tmp49_;
			gint _tmp50_;
			GdkRectangle _tmp51_;
			gint _tmp52_;
			gint _tmp53_;
			gint _tmp54_;
			self->arrow_up = TRUE;
			_tmp41_ = *rect;
			_tmp42_ = _tmp41_.x;
			_tmp43_ = gtk_widget_get_allocated_width ((GtkWidget*) self);
			_tmp44_ = self->SHADOW_SIZE;
			_tmp45_ = self->ARROW_WIDTH;
			_tmp46_ = *rect;
			_tmp47_ = _tmp46_.width;
			self->priv->win_x = (((_tmp42_ - _tmp43_) + (2 * _tmp44_)) + (_tmp45_ / 2)) + (_tmp47_ / 2);
			_tmp48_ = *rect;
			_tmp49_ = _tmp48_.y;
			_tmp50_ = self->SHADOW_SIZE;
			_tmp51_ = *rect;
			_tmp52_ = _tmp51_.height;
			self->priv->win_y = (_tmp49_ - _tmp50_) + _tmp52_;
			_tmp53_ = gtk_widget_get_allocated_width ((GtkWidget*) self);
			_tmp54_ = self->SHADOW_SIZE;
			self->arrow_offset = (_tmp53_ - (2 * _tmp54_)) - 30.0;
			break;
		}
		case GRANITE_WIDGETS_POP_OVER_POP_POSITION_TOPLEFT:
		{
			GdkRectangle _tmp55_;
			gint _tmp56_;
			gint _tmp57_;
			gint _tmp58_;
			GdkRectangle _tmp59_;
			gint _tmp60_;
			GdkRectangle _tmp61_;
			gint _tmp62_;
			gint _tmp63_;
			GdkRectangle _tmp64_;
			gint _tmp65_;
			gint _tmp66_;
			self->arrow_up = TRUE;
			_tmp55_ = *rect;
			_tmp56_ = _tmp55_.x;
			_tmp57_ = self->SHADOW_SIZE;
			_tmp58_ = self->ARROW_WIDTH;
			_tmp59_ = *rect;
			_tmp60_ = _tmp59_.width;
			self->priv->win_x = (((_tmp56_ - 30) - _tmp57_) - (_tmp58_ / 2)) + (_tmp60_ / 2);
			_tmp61_ = *rect;
			_tmp62_ = _tmp61_.y;
			_tmp63_ = self->SHADOW_SIZE;
			_tmp64_ = *rect;
			_tmp65_ = _tmp64_.height;
			self->priv->win_y = (_tmp62_ - _tmp63_) + _tmp65_;
			_tmp66_ = self->SHADOW_SIZE;
			self->arrow_offset = _tmp66_ + 30.0;
			break;
		}
		case GRANITE_WIDGETS_POP_OVER_POP_POSITION_BOTTOMLEFT:
		{
			GdkRectangle _tmp67_;
			gint _tmp68_;
			gint _tmp69_;
			gint _tmp70_;
			GdkRectangle _tmp71_;
			gint _tmp72_;
			GdkRectangle _tmp73_;
			gint _tmp74_;
			gint _tmp75_;
			gint _tmp76_;
			gint _tmp77_;
			self->arrow_up = FALSE;
			_tmp67_ = *rect;
			_tmp68_ = _tmp67_.x;
			_tmp69_ = self->SHADOW_SIZE;
			_tmp70_ = self->ARROW_WIDTH;
			_tmp71_ = *rect;
			_tmp72_ = _tmp71_.width;
			self->priv->win_x = (((_tmp68_ - 30) - _tmp69_) - (_tmp70_ / 2)) + (_tmp72_ / 2);
			_tmp73_ = *rect;
			_tmp74_ = _tmp73_.y;
			_tmp75_ = gtk_widget_get_allocated_height ((GtkWidget*) self);
			_tmp76_ = self->SHADOW_SIZE;
			self->priv->win_y = (_tmp74_ - _tmp75_) + _tmp76_;
			_tmp77_ = self->SHADOW_SIZE;
			self->arrow_offset = _tmp77_ + 30.0;
			break;
		}
		default:
		{
			break;
		}
	}
	_tmp78_ = self->arrow_up;
	if (_tmp78_) {
		GtkBox* _tmp79_;
		GtkBorder _tmp80_;
		gint16 _tmp81_;
		gint _tmp82_;
		gint _tmp83_;
		GtkBox* _tmp84_;
		GtkBorder _tmp85_;
		gint16 _tmp86_;
		gint _tmp87_;
		_tmp79_ = self->priv->hbox;
		_tmp80_ = self->PADDINGS;
		_tmp81_ = _tmp80_.top;
		_tmp82_ = self->SHADOW_SIZE;
		_tmp83_ = self->ARROW_HEIGHT;
		gtk_widget_set_margin_top ((GtkWidget*) _tmp79_, ((_tmp81_ + _tmp82_) + _tmp83_) + 5);
		_tmp84_ = self->priv->abox;
		_tmp85_ = self->PADDINGS;
		_tmp86_ = _tmp85_.bottom;
		_tmp87_ = self->SHADOW_SIZE;
		gtk_widget_set_margin_bottom ((GtkWidget*) _tmp84_, _tmp86_ + _tmp87_);
	} else {
		GtkBox* _tmp88_;
		GtkBorder _tmp89_;
		gint16 _tmp90_;
		gint _tmp91_;
		GtkBox* _tmp92_;
		GtkBorder _tmp93_;
		gint16 _tmp94_;
		gint _tmp95_;
		gint _tmp96_;
		_tmp88_ = self->priv->hbox;
		_tmp89_ = self->PADDINGS;
		_tmp90_ = _tmp89_.top;
		_tmp91_ = self->SHADOW_SIZE;
		gtk_widget_set_margin_top ((GtkWidget*) _tmp88_, (_tmp90_ + _tmp91_) + 5);
		_tmp92_ = self->priv->abox;
		_tmp93_ = self->PADDINGS;
		_tmp94_ = _tmp93_.bottom;
		_tmp95_ = self->SHADOW_SIZE;
		_tmp96_ = self->ARROW_HEIGHT;
		gtk_widget_set_margin_bottom ((GtkWidget*) _tmp92_, (_tmp94_ + _tmp95_) + _tmp96_);
	}
	_tmp97_ = old_pos;
	_tmp98_ = self->priv->pos;
	if (_tmp97_ != _tmp98_) {
		gint _tmp99_;
		gint _tmp100_;
		_tmp99_ = gtk_widget_get_allocated_width ((GtkWidget*) self);
		_tmp100_ = gtk_widget_get_allocated_height ((GtkWidget*) self);
		granite_widgets_pop_over_compute_shadow (self, _tmp99_, _tmp100_);
	}
	_tmp101_ = gtk_widget_get_allocated_width ((GtkWidget*) self);
	w = _tmp101_;
	_tmp102_ = gtk_widget_get_allocated_height ((GtkWidget*) self);
	h = _tmp102_;
	_tmp103_ = h;
	_tmp104_ = self->PADDINGS;
	_tmp105_ = _tmp104_.top;
	_tmp106_ = self->SHADOW_SIZE;
	_tmp107_ = self->ARROW_HEIGHT;
	h = _tmp103_ - ((2 * (_tmp105_ + _tmp106_)) + _tmp107_);
	_tmp108_ = w;
	_tmp109_ = self->PADDINGS;
	_tmp110_ = _tmp109_.right;
	_tmp111_ = self->SHADOW_SIZE;
	w = _tmp108_ - (2 * (_tmp110_ + _tmp111_));
	_tmp113_ = self->arrow_up;
	if (_tmp113_) {
		gint _tmp114_;
		_tmp114_ = self->ARROW_HEIGHT;
		_tmp112_ = _tmp114_;
	} else {
		_tmp112_ = 0;
	}
	_tmp115_ = gtk_widget_get_window ((GtkWidget*) self);
	_tmp116_ = w;
	_tmp117_ = h;
	_tmp118_.x = 0;
	_tmp118_.y = 0;
	_tmp118_.width = _tmp116_;
	_tmp118_.height = _tmp117_;
	_tmp119_ = cairo_region_create_rectangle (&_tmp118_);
	_tmp120_ = _tmp119_;
	_tmp121_ = self->PADDINGS;
	_tmp122_ = _tmp121_.right;
	_tmp123_ = self->SHADOW_SIZE;
	_tmp124_ = self->PADDINGS;
	_tmp125_ = _tmp124_.top;
	_tmp126_ = self->SHADOW_SIZE;
	gdk_window_input_shape_combine_region (_tmp115_, _tmp120_, _tmp122_ + _tmp123_, (_tmp125_ + _tmp126_) + _tmp112_);
	_cairo_region_destroy0 (_tmp120_);
}


/**
     * Change the position of the popover, to display it under w.
     *
     * The arrow of the PopOver is moved at the bottom of the widget, and it is
     * horizontally centered.
     *
     * @param w a normal Gtk.Widget, e.g. a button
     */
void granite_widgets_pop_over_move_to_widget (GraniteWidgetsPopOver* self, GtkWidget* w, gboolean show) {
	gint x = 0;
	gint y = 0;
	GdkRectangle rectangle = {0};
	gboolean is_visible_window = FALSE;
	GtkWidget* _tmp0_;
	GtkWidget* _tmp5_;
	GdkWindow* _tmp6_;
	gint _tmp7_ = 0;
	gint _tmp8_ = 0;
	GtkAllocation alloc = {0};
	GtkWidget* _tmp9_;
	GtkAllocation _tmp10_ = {0};
	GtkWidget* _tmp11_;
	gint _tmp14_;
	GtkAllocation _tmp15_;
	gint _tmp16_;
	gint _tmp17_;
	GtkAllocation _tmp18_;
	gint _tmp19_;
	gint _tmp20_;
	gint _tmp21_;
	GtkAllocation _tmp22_;
	gint _tmp23_;
	GtkAllocation _tmp24_;
	gint _tmp25_;
	gboolean _tmp26_;
	GtkWidget* _tmp27_;
	GdkScreen* _tmp28_;
	GdkRectangle _tmp29_;
	gint _tmp30_;
	gint _tmp31_;
	GtkWidget* _tmp32_;
	GtkWidget* _tmp33_;
	g_return_if_fail (self != NULL);
	g_return_if_fail (w != NULL);
	memset (&rectangle, 0, sizeof (GdkRectangle));
	is_visible_window = FALSE;
	_tmp0_ = w;
	if (G_TYPE_CHECK_INSTANCE_TYPE (_tmp0_, gtk_event_box_get_type ())) {
		GtkWidget* _tmp1_;
		gboolean _tmp2_;
		gboolean _tmp3_;
		GtkWidget* _tmp4_;
		_tmp1_ = w;
		_tmp2_ = gtk_event_box_get_visible_window (G_TYPE_CHECK_INSTANCE_TYPE (_tmp1_, gtk_event_box_get_type ()) ? ((GtkEventBox*) _tmp1_) : NULL);
		_tmp3_ = _tmp2_;
		is_visible_window = _tmp3_;
		_tmp4_ = w;
		gtk_event_box_set_visible_window (G_TYPE_CHECK_INSTANCE_TYPE (_tmp4_, gtk_event_box_get_type ()) ? ((GtkEventBox*) _tmp4_) : NULL, FALSE);
	}
	_tmp5_ = w;
	_tmp6_ = gtk_widget_get_window (_tmp5_);
	gdk_window_get_origin (_tmp6_, &_tmp7_, &_tmp8_);
	x = _tmp7_;
	y = _tmp8_;
	_tmp9_ = w;
	gtk_widget_get_allocation (_tmp9_, &_tmp10_);
	alloc = _tmp10_;
	_tmp11_ = w;
	if (G_TYPE_CHECK_INSTANCE_TYPE (_tmp11_, gtk_event_box_get_type ())) {
		GtkWidget* _tmp12_;
		gboolean _tmp13_;
		_tmp12_ = w;
		_tmp13_ = is_visible_window;
		gtk_event_box_set_visible_window (G_TYPE_CHECK_INSTANCE_TYPE (_tmp12_, gtk_event_box_get_type ()) ? ((GtkEventBox*) _tmp12_) : NULL, _tmp13_);
	}
	_tmp14_ = x;
	_tmp15_ = alloc;
	_tmp16_ = _tmp15_.x;
	x = _tmp14_ + _tmp16_;
	_tmp17_ = y;
	_tmp18_ = alloc;
	_tmp19_ = _tmp18_.y;
	y = _tmp17_ + _tmp19_;
	_tmp20_ = x;
	rectangle.x = _tmp20_;
	_tmp21_ = y;
	rectangle.y = _tmp21_;
	_tmp22_ = alloc;
	_tmp23_ = _tmp22_.width;
	rectangle.width = _tmp23_;
	_tmp24_ = alloc;
	_tmp25_ = _tmp24_.height;
	rectangle.height = _tmp25_;
	_tmp26_ = show;
	if (_tmp26_) {
		gtk_widget_show_all ((GtkWidget*) self);
	}
	_tmp27_ = w;
	_tmp28_ = gtk_widget_get_screen (_tmp27_);
	_tmp29_ = rectangle;
	granite_widgets_pop_over_compute_pop_position (self, _tmp28_, &_tmp29_);
	_tmp30_ = self->priv->win_x;
	_tmp31_ = self->priv->win_y;
	gtk_window_move ((GtkWindow*) self, _tmp30_, _tmp31_);
	_tmp32_ = w;
	_tmp33_ = gtk_widget_get_toplevel (_tmp32_);
	granite_widgets_pop_over_set_parent_pop (self, G_TYPE_CHECK_INSTANCE_TYPE (_tmp33_, gtk_window_get_type ()) ? ((GtkWindow*) _tmp33_) : NULL);
}


void granite_widgets_pop_over_move_to_coords (GraniteWidgetsPopOver* self, gint x, gint y, gboolean show) {
	gboolean _tmp0_;
	GdkRectangle rect = {0};
	gint _tmp1_;
	gint _tmp2_;
	GdkScreen* _tmp3_;
	GdkRectangle _tmp4_;
	gint _tmp5_;
	gint _tmp6_;
	g_return_if_fail (self != NULL);
	_tmp0_ = show;
	if (_tmp0_) {
		gtk_widget_show_all ((GtkWidget*) self);
	}
	memset (&rect, 0, sizeof (GdkRectangle));
	_tmp1_ = x;
	rect.x = _tmp1_;
	_tmp2_ = y;
	rect.y = _tmp2_;
	rect.width = 1;
	rect.height = 1;
	_tmp3_ = gtk_window_get_screen ((GtkWindow*) self);
	_tmp4_ = rect;
	granite_widgets_pop_over_compute_pop_position (self, _tmp3_, &_tmp4_);
	_tmp5_ = self->priv->win_x;
	_tmp6_ = self->priv->win_y;
	gtk_window_move ((GtkWindow*) self, _tmp5_, _tmp6_);
}


/**
     * Move the popover to the coordinates of the given Gdk.Rectangle and
     * position it acording to the width and height of the rectangle.
     */
void granite_widgets_pop_over_move_to_rect (GraniteWidgetsPopOver* self, GdkRectangle* rect, gboolean show) {
	gboolean _tmp0_;
	GdkScreen* _tmp1_;
	GdkRectangle _tmp2_;
	gint _tmp3_;
	gint _tmp4_;
	g_return_if_fail (self != NULL);
	g_return_if_fail (rect != NULL);
	_tmp0_ = show;
	if (_tmp0_) {
		gtk_widget_show_all ((GtkWidget*) self);
	}
	_tmp1_ = gtk_window_get_screen ((GtkWindow*) self);
	_tmp2_ = *rect;
	granite_widgets_pop_over_compute_pop_position (self, _tmp1_, &_tmp2_);
	_tmp3_ = self->priv->win_x;
	_tmp4_ = self->priv->win_y;
	gtk_window_move ((GtkWindow*) self, _tmp3_, _tmp4_);
}


/**
     * Move the popover to the Gdk.Window window. The recommand method is
     * move_to_widget, but this one can be used when we don't know which widget
     * triggered the action (e.g. with a Gtk.Action).
     */
void granite_widgets_pop_over_move_to_window (GraniteWidgetsPopOver* self, GdkWindow* window) {
	gint x = 0;
	gint y = 0;
	GdkWindow* _tmp0_;
	gint _tmp1_ = 0;
	gint _tmp2_ = 0;
	GdkWindow* _tmp3_;
	gint _tmp4_ = 0;
	gint _tmp5_ = 0;
	gint _tmp6_;
	GdkWindow* _tmp7_;
	gint _tmp8_;
	gint _tmp9_;
	gdouble _tmp10_;
	gint _tmp11_;
	GdkWindow* _tmp12_;
	gint _tmp13_;
	gint _tmp14_;
	gint _tmp15_;
	gint _tmp16_;
	g_return_if_fail (self != NULL);
	g_return_if_fail (window != NULL);
	_tmp0_ = window;
	gdk_window_get_root_origin (_tmp0_, &_tmp1_, &_tmp2_);
	x = _tmp1_;
	y = _tmp2_;
	_tmp3_ = window;
	gdk_window_get_origin (_tmp3_, &_tmp4_, &_tmp5_);
	x = _tmp4_;
	y = _tmp5_;
	_tmp6_ = x;
	_tmp7_ = window;
	_tmp8_ = gdk_window_get_width (_tmp7_);
	_tmp9_ = self->SHADOW_SIZE;
	_tmp10_ = self->priv->offset;
	x = _tmp6_ + ((((_tmp8_ / 2) - GRANITE_WIDGETS_POP_OVER_MARGIN) - _tmp9_) - ((gint) _tmp10_));
	_tmp11_ = y;
	_tmp12_ = window;
	_tmp13_ = gdk_window_get_height (_tmp12_);
	_tmp14_ = self->SHADOW_SIZE;
	y = _tmp11_ + (_tmp13_ - _tmp14_);
	gtk_widget_show_all ((GtkWidget*) self);
	gtk_widget_show_now ((GtkWidget*) self);
	_tmp15_ = x;
	_tmp16_ = y;
	gtk_window_move ((GtkWindow*) self, _tmp15_, _tmp16_);
}


void granite_widgets_pop_over_cairo_popover (GraniteWidgetsPopOver* self, cairo_t* cr, gdouble x, gdouble y, gdouble width, gdouble height, gdouble border_radius) {
	gboolean _tmp0_;
	gboolean _tmp39_;
	cairo_t* _tmp84_;
	g_return_if_fail (self != NULL);
	g_return_if_fail (cr != NULL);
	_tmp0_ = self->arrow_up;
	if (_tmp0_) {
		cairo_t* _tmp1_;
		gdouble _tmp2_;
		gdouble _tmp3_;
		gdouble _tmp4_;
		gint _tmp5_;
		gdouble _tmp6_;
		gdouble _tmp7_;
		cairo_t* _tmp8_;
		gdouble _tmp9_;
		gdouble _tmp10_;
		gint _tmp11_;
		cairo_t* _tmp12_;
		gint _tmp13_;
		gint _tmp14_;
		cairo_t* _tmp15_;
		gint _tmp16_;
		gint _tmp17_;
		cairo_t* _tmp18_;
		gdouble _tmp19_;
		gdouble _tmp20_;
		gdouble _tmp21_;
		gdouble _tmp22_;
		gint _tmp23_;
		gdouble _tmp24_;
		gdouble _tmp25_;
		_tmp1_ = cr;
		_tmp2_ = x;
		_tmp3_ = border_radius;
		_tmp4_ = y;
		_tmp5_ = self->ARROW_HEIGHT;
		_tmp6_ = border_radius;
		_tmp7_ = border_radius;
		cairo_arc (_tmp1_, _tmp2_ + _tmp3_, (_tmp4_ + _tmp5_) + _tmp6_, _tmp7_, G_PI, G_PI * 1.5);
		_tmp8_ = cr;
		_tmp9_ = self->arrow_offset;
		_tmp10_ = y;
		_tmp11_ = self->ARROW_HEIGHT;
		cairo_line_to (_tmp8_, _tmp9_, _tmp10_ + _tmp11_);
		_tmp12_ = cr;
		_tmp13_ = self->ARROW_WIDTH;
		_tmp14_ = self->ARROW_HEIGHT;
		cairo_rel_line_to (_tmp12_, _tmp13_ / 2.0, (gdouble) (-_tmp14_));
		_tmp15_ = cr;
		_tmp16_ = self->ARROW_WIDTH;
		_tmp17_ = self->ARROW_HEIGHT;
		cairo_rel_line_to (_tmp15_, _tmp16_ / 2.0, (gdouble) _tmp17_);
		_tmp18_ = cr;
		_tmp19_ = x;
		_tmp20_ = width;
		_tmp21_ = border_radius;
		_tmp22_ = y;
		_tmp23_ = self->ARROW_HEIGHT;
		_tmp24_ = border_radius;
		_tmp25_ = border_radius;
		cairo_arc (_tmp18_, (_tmp19_ + _tmp20_) - _tmp21_, (_tmp22_ + _tmp23_) + _tmp24_, _tmp25_, G_PI * 1.5, G_PI * 2.0);
	} else {
		cairo_t* _tmp26_;
		gdouble _tmp27_;
		gdouble _tmp28_;
		gdouble _tmp29_;
		gdouble _tmp30_;
		gdouble _tmp31_;
		cairo_t* _tmp32_;
		gdouble _tmp33_;
		gdouble _tmp34_;
		gdouble _tmp35_;
		gdouble _tmp36_;
		gdouble _tmp37_;
		gdouble _tmp38_;
		_tmp26_ = cr;
		_tmp27_ = x;
		_tmp28_ = border_radius;
		_tmp29_ = y;
		_tmp30_ = border_radius;
		_tmp31_ = border_radius;
		cairo_arc (_tmp26_, _tmp27_ + _tmp28_, _tmp29_ + _tmp30_, _tmp31_, G_PI, G_PI * 1.5);
		_tmp32_ = cr;
		_tmp33_ = x;
		_tmp34_ = width;
		_tmp35_ = border_radius;
		_tmp36_ = y;
		_tmp37_ = border_radius;
		_tmp38_ = border_radius;
		cairo_arc (_tmp32_, (_tmp33_ + _tmp34_) - _tmp35_, _tmp36_ + _tmp37_, _tmp38_, G_PI * 1.5, G_PI * 2.0);
	}
	_tmp39_ = self->arrow_up;
	if (_tmp39_) {
		cairo_t* _tmp40_;
		gdouble _tmp41_;
		gdouble _tmp42_;
		gdouble _tmp43_;
		gdouble _tmp44_;
		gdouble _tmp45_;
		gdouble _tmp46_;
		gdouble _tmp47_;
		cairo_t* _tmp48_;
		gdouble _tmp49_;
		gdouble _tmp50_;
		gdouble _tmp51_;
		gdouble _tmp52_;
		gdouble _tmp53_;
		gdouble _tmp54_;
		_tmp40_ = cr;
		_tmp41_ = x;
		_tmp42_ = width;
		_tmp43_ = border_radius;
		_tmp44_ = y;
		_tmp45_ = height;
		_tmp46_ = border_radius;
		_tmp47_ = border_radius;
		cairo_arc (_tmp40_, (_tmp41_ + _tmp42_) - _tmp43_, (_tmp44_ + _tmp45_) - _tmp46_, _tmp47_, (gdouble) 0, G_PI * 0.5);
		_tmp48_ = cr;
		_tmp49_ = x;
		_tmp50_ = border_radius;
		_tmp51_ = y;
		_tmp52_ = height;
		_tmp53_ = border_radius;
		_tmp54_ = border_radius;
		cairo_arc (_tmp48_, _tmp49_ + _tmp50_, (_tmp51_ + _tmp52_) - _tmp53_, _tmp54_, G_PI * 0.5, G_PI);
	} else {
		cairo_t* _tmp55_;
		gdouble _tmp56_;
		gdouble _tmp57_;
		gdouble _tmp58_;
		gdouble _tmp59_;
		gdouble _tmp60_;
		gint _tmp61_;
		gdouble _tmp62_;
		gdouble _tmp63_;
		cairo_t* _tmp64_;
		gdouble _tmp65_;
		gint _tmp66_;
		gdouble _tmp67_;
		gdouble _tmp68_;
		gint _tmp69_;
		cairo_t* _tmp70_;
		gint _tmp71_;
		gint _tmp72_;
		cairo_t* _tmp73_;
		gint _tmp74_;
		gint _tmp75_;
		cairo_t* _tmp76_;
		gdouble _tmp77_;
		gdouble _tmp78_;
		gdouble _tmp79_;
		gdouble _tmp80_;
		gint _tmp81_;
		gdouble _tmp82_;
		gdouble _tmp83_;
		_tmp55_ = cr;
		_tmp56_ = x;
		_tmp57_ = width;
		_tmp58_ = border_radius;
		_tmp59_ = y;
		_tmp60_ = height;
		_tmp61_ = self->ARROW_HEIGHT;
		_tmp62_ = border_radius;
		_tmp63_ = border_radius;
		cairo_arc (_tmp55_, (_tmp56_ + _tmp57_) - _tmp58_, ((_tmp59_ + _tmp60_) - _tmp61_) - _tmp62_, _tmp63_, (gdouble) 0, G_PI * 0.5);
		_tmp64_ = cr;
		_tmp65_ = self->arrow_offset;
		_tmp66_ = self->ARROW_WIDTH;
		_tmp67_ = y;
		_tmp68_ = height;
		_tmp69_ = self->ARROW_HEIGHT;
		cairo_line_to (_tmp64_, _tmp65_ + _tmp66_, (_tmp67_ + _tmp68_) - _tmp69_);
		_tmp70_ = cr;
		_tmp71_ = self->ARROW_WIDTH;
		_tmp72_ = self->ARROW_HEIGHT;
		cairo_rel_line_to (_tmp70_, (-_tmp71_) / 2.0, (gdouble) _tmp72_);
		_tmp73_ = cr;
		_tmp74_ = self->ARROW_WIDTH;
		_tmp75_ = self->ARROW_HEIGHT;
		cairo_rel_line_to (_tmp73_, (-_tmp74_) / 2.0, (gdouble) (-_tmp75_));
		_tmp76_ = cr;
		_tmp77_ = x;
		_tmp78_ = border_radius;
		_tmp79_ = y;
		_tmp80_ = height;
		_tmp81_ = self->ARROW_HEIGHT;
		_tmp82_ = border_radius;
		_tmp83_ = border_radius;
		cairo_arc (_tmp76_, _tmp77_ + _tmp78_, ((_tmp79_ + _tmp80_) - _tmp81_) - _tmp82_, _tmp83_, G_PI * 0.5, G_PI);
	}
	_tmp84_ = cr;
	cairo_close_path (_tmp84_);
}


static void granite_widgets_pop_over_compute_shadow (GraniteWidgetsPopOver* self, gint w, gint h) {
	gint _tmp0_;
	gint _tmp1_;
	GraniteDrawingBufferSurface* _tmp2_;
	GraniteDrawingBufferSurface* _tmp3_;
	cairo_t* _tmp4_;
	cairo_t* _tmp5_;
	gint _tmp6_;
	gint _tmp7_;
	gint _tmp8_;
	gint _tmp9_;
	gint _tmp10_;
	gint _tmp11_;
	gint _tmp12_;
	gint _tmp13_;
	gint _tmp14_;
	gint _tmp15_;
	gint _tmp16_;
	GraniteDrawingBufferSurface* _tmp17_;
	cairo_t* _tmp18_;
	cairo_t* _tmp19_;
	GraniteDrawingBufferSurface* _tmp20_;
	cairo_t* _tmp21_;
	cairo_t* _tmp22_;
	GraniteDrawingBufferSurface* _tmp23_;
	gint _tmp24_;
	GraniteDrawingBufferSurface* _tmp25_;
	cairo_t* _tmp26_;
	cairo_t* _tmp27_;
	GtkWidget* _tmp28_;
	GtkStyleContext* _tmp29_;
	GraniteDrawingBufferSurface* _tmp30_;
	cairo_t* _tmp31_;
	cairo_t* _tmp32_;
	gint _tmp33_;
	gint _tmp34_;
	GdkWindow* _tmp35_;
	GraniteDrawingBufferSurface* _tmp58_;
	cairo_t* _tmp59_;
	cairo_t* _tmp60_;
	GraniteDrawingBufferSurface* _tmp61_;
	cairo_t* _tmp62_;
	cairo_t* _tmp63_;
	gint _tmp64_;
	gint _tmp65_;
	gint _tmp66_;
	gint _tmp67_;
	gint _tmp68_;
	gint _tmp69_;
	gint _tmp70_;
	gint _tmp71_;
	gint _tmp72_;
	gint _tmp73_;
	gint _tmp74_;
	GraniteDrawingBufferSurface* _tmp75_;
	cairo_t* _tmp76_;
	cairo_t* _tmp77_;
	GraniteDrawingBufferSurface* _tmp78_;
	cairo_t* _tmp79_;
	cairo_t* _tmp80_;
	gint _tmp81_;
	GraniteDrawingBufferSurface* _tmp82_;
	cairo_t* _tmp83_;
	cairo_t* _tmp84_;
	GtkStyleContext* _tmp85_;
	GdkRGBA _tmp86_ = {0};
	GraniteDrawingBufferSurface* _tmp87_;
	cairo_t* _tmp88_;
	cairo_t* _tmp89_;
	g_return_if_fail (self != NULL);
	_tmp0_ = w;
	_tmp1_ = h;
	_tmp2_ = granite_drawing_buffer_surface_new (_tmp0_, _tmp1_);
	_g_object_unref0 (self->main_buffer);
	self->main_buffer = _tmp2_;
	_tmp3_ = self->main_buffer;
	_tmp4_ = granite_drawing_buffer_surface_get_context (_tmp3_);
	_tmp5_ = _tmp4_;
	_tmp6_ = self->SHADOW_SIZE;
	_tmp7_ = self->BORDER_WIDTH;
	_tmp8_ = self->SHADOW_SIZE;
	_tmp9_ = self->BORDER_WIDTH;
	_tmp10_ = w;
	_tmp11_ = self->SHADOW_SIZE;
	_tmp12_ = self->BORDER_WIDTH;
	_tmp13_ = h;
	_tmp14_ = self->SHADOW_SIZE;
	_tmp15_ = self->BORDER_WIDTH;
	_tmp16_ = self->BORDER_RADIUS;
	granite_widgets_pop_over_cairo_popover (self, _tmp5_, _tmp6_ + (_tmp7_ / 2.0), _tmp8_ + (_tmp9_ / 2.0), (gdouble) ((_tmp10_ - (_tmp11_ * 2)) - _tmp12_), (gdouble) ((_tmp13_ - (_tmp14_ * 2)) - _tmp15_), (gdouble) _tmp16_);
	_tmp17_ = self->main_buffer;
	_tmp18_ = granite_drawing_buffer_surface_get_context (_tmp17_);
	_tmp19_ = _tmp18_;
	cairo_set_source_rgba (_tmp19_, 0.0, 0.0, 0.0, 0.4);
	_tmp20_ = self->main_buffer;
	_tmp21_ = granite_drawing_buffer_surface_get_context (_tmp20_);
	_tmp22_ = _tmp21_;
	cairo_fill_preserve (_tmp22_);
	_tmp23_ = self->main_buffer;
	_tmp24_ = self->SHADOW_SIZE;
	granite_drawing_buffer_surface_exponential_blur (_tmp23_, (_tmp24_ / 2) - 1);
	_tmp25_ = self->main_buffer;
	_tmp26_ = granite_drawing_buffer_surface_get_context (_tmp25_);
	_tmp27_ = _tmp26_;
	cairo_clip (_tmp27_);
	_tmp28_ = self->priv->menu;
	_tmp29_ = gtk_widget_get_style_context (_tmp28_);
	_tmp30_ = self->main_buffer;
	_tmp31_ = granite_drawing_buffer_surface_get_context (_tmp30_);
	_tmp32_ = _tmp31_;
	_tmp33_ = w;
	_tmp34_ = h;
	gtk_render_background (_tmp29_, _tmp32_, (gdouble) 0, (gdouble) 0, (gdouble) _tmp33_, (gdouble) _tmp34_);
	_tmp35_ = gtk_widget_get_window ((GtkWidget*) self);
	if (_tmp35_ != NULL) {
		gint _tmp36_ = 0;
		gboolean _tmp37_;
		GdkWindow* _tmp39_;
		gint _tmp40_;
		GtkBorder _tmp41_;
		gint16 _tmp42_;
		gint _tmp43_;
		gint _tmp44_;
		GtkBorder _tmp45_;
		gint16 _tmp46_;
		gint _tmp47_;
		gint _tmp48_;
		cairo_rectangle_int_t _tmp49_ = {0};
		cairo_region_t* _tmp50_;
		cairo_region_t* _tmp51_;
		GtkBorder _tmp52_;
		gint16 _tmp53_;
		gint _tmp54_;
		GtkBorder _tmp55_;
		gint16 _tmp56_;
		gint _tmp57_;
		_tmp37_ = self->arrow_up;
		if (_tmp37_) {
			gint _tmp38_;
			_tmp38_ = self->ARROW_HEIGHT;
			_tmp36_ = _tmp38_;
		} else {
			_tmp36_ = 0;
		}
		_tmp39_ = gtk_widget_get_window ((GtkWidget*) self);
		_tmp40_ = w;
		_tmp41_ = self->PADDINGS;
		_tmp42_ = _tmp41_.right;
		_tmp43_ = self->SHADOW_SIZE;
		_tmp44_ = h;
		_tmp45_ = self->PADDINGS;
		_tmp46_ = _tmp45_.top;
		_tmp47_ = self->SHADOW_SIZE;
		_tmp48_ = self->ARROW_HEIGHT;
		_tmp49_.x = 0;
		_tmp49_.y = 0;
		_tmp49_.width = _tmp40_ - (2 * (_tmp42_ + _tmp43_));
		_tmp49_.height = (_tmp44_ - (2 * (_tmp46_ + _tmp47_))) - _tmp48_;
		_tmp50_ = cairo_region_create_rectangle (&_tmp49_);
		_tmp51_ = _tmp50_;
		_tmp52_ = self->PADDINGS;
		_tmp53_ = _tmp52_.right;
		_tmp54_ = self->SHADOW_SIZE;
		_tmp55_ = self->PADDINGS;
		_tmp56_ = _tmp55_.top;
		_tmp57_ = self->SHADOW_SIZE;
		gdk_window_input_shape_combine_region (_tmp39_, _tmp51_, _tmp53_ + _tmp54_, (_tmp56_ + _tmp57_) + _tmp36_);
		_cairo_region_destroy0 (_tmp51_);
	}
	_tmp58_ = self->main_buffer;
	_tmp59_ = granite_drawing_buffer_surface_get_context (_tmp58_);
	_tmp60_ = _tmp59_;
	cairo_reset_clip (_tmp60_);
	_tmp61_ = self->main_buffer;
	_tmp62_ = granite_drawing_buffer_surface_get_context (_tmp61_);
	_tmp63_ = _tmp62_;
	_tmp64_ = self->SHADOW_SIZE;
	_tmp65_ = self->BORDER_WIDTH;
	_tmp66_ = self->SHADOW_SIZE;
	_tmp67_ = self->BORDER_WIDTH;
	_tmp68_ = w;
	_tmp69_ = self->SHADOW_SIZE;
	_tmp70_ = self->BORDER_WIDTH;
	_tmp71_ = h;
	_tmp72_ = self->SHADOW_SIZE;
	_tmp73_ = self->BORDER_WIDTH;
	_tmp74_ = self->BORDER_RADIUS;
	granite_widgets_pop_over_cairo_popover (self, _tmp63_, _tmp64_ + (_tmp65_ / 2.0), _tmp66_ + (_tmp67_ / 2.0), (gdouble) ((_tmp68_ - (_tmp69_ * 2)) - _tmp70_), (gdouble) ((_tmp71_ - (_tmp72_ * 2)) - _tmp73_), (gdouble) _tmp74_);
	_tmp75_ = self->main_buffer;
	_tmp76_ = granite_drawing_buffer_surface_get_context (_tmp75_);
	_tmp77_ = _tmp76_;
	cairo_set_operator (_tmp77_, CAIRO_OPERATOR_SOURCE);
	_tmp78_ = self->main_buffer;
	_tmp79_ = granite_drawing_buffer_surface_get_context (_tmp78_);
	_tmp80_ = _tmp79_;
	_tmp81_ = self->BORDER_WIDTH;
	cairo_set_line_width (_tmp80_, (gdouble) _tmp81_);
	_tmp82_ = self->main_buffer;
	_tmp83_ = granite_drawing_buffer_surface_get_context (_tmp82_);
	_tmp84_ = _tmp83_;
	_tmp85_ = gtk_widget_get_style_context ((GtkWidget*) self);
	gtk_style_context_get_border_color (_tmp85_, GTK_STATE_FLAG_NORMAL, &_tmp86_);
	gdk_cairo_set_source_rgba (_tmp84_, &_tmp86_);
	_tmp87_ = self->main_buffer;
	_tmp88_ = granite_drawing_buffer_surface_get_context (_tmp87_);
	_tmp89_ = _tmp88_;
	cairo_stroke (_tmp89_);
}


static void granite_widgets_pop_over_on_size_allocate (GraniteWidgetsPopOver* self, GtkAllocation* alloc) {
	gint w = 0;
	gint _tmp0_;
	gint h = 0;
	gint _tmp1_;
	gboolean _tmp2_ = FALSE;
	gint _tmp3_;
	gint _tmp4_;
	gint _tmp7_;
	gint _tmp8_;
	gint _tmp9_;
	gint _tmp10_;
	g_return_if_fail (self != NULL);
	g_return_if_fail (alloc != NULL);
	_tmp0_ = gtk_widget_get_allocated_width ((GtkWidget*) self);
	w = _tmp0_;
	_tmp1_ = gtk_widget_get_allocated_height ((GtkWidget*) self);
	h = _tmp1_;
	_tmp3_ = self->priv->old_w;
	_tmp4_ = w;
	if (_tmp3_ == _tmp4_) {
		gint _tmp5_;
		gint _tmp6_;
		_tmp5_ = self->priv->old_h;
		_tmp6_ = h;
		_tmp2_ = _tmp5_ == _tmp6_;
	} else {
		_tmp2_ = FALSE;
	}
	if (_tmp2_) {
		return;
	}
	_tmp7_ = w;
	_tmp8_ = h;
	granite_widgets_pop_over_compute_shadow (self, _tmp7_, _tmp8_);
	_tmp9_ = w;
	self->priv->old_w = _tmp9_;
	_tmp10_ = h;
	self->priv->old_h = _tmp10_;
}


static gboolean granite_widgets_pop_over_real_draw (GtkWidget* base, cairo_t* cr) {
	GraniteWidgetsPopOver * self;
	gboolean result = FALSE;
	cairo_t* _tmp0_;
	GraniteDrawingBufferSurface* _tmp1_;
	cairo_surface_t* _tmp2_;
	cairo_surface_t* _tmp3_;
	cairo_t* _tmp4_;
	cairo_t* _tmp5_;
	gboolean _tmp6_;
	self = (GraniteWidgetsPopOver*) base;
	g_return_val_if_fail (cr != NULL, FALSE);
	_tmp0_ = cr;
	_tmp1_ = self->main_buffer;
	_tmp2_ = granite_drawing_buffer_surface_get_surface (_tmp1_);
	_tmp3_ = _tmp2_;
	cairo_set_source_surface (_tmp0_, _tmp3_, (gdouble) 0, (gdouble) 0);
	_tmp4_ = cr;
	cairo_paint_with_alpha (_tmp4_, 1.0);
	_tmp5_ = cr;
	_tmp6_ = GTK_WIDGET_CLASS (granite_widgets_pop_over_parent_class)->draw ((GtkWidget*) G_TYPE_CHECK_INSTANCE_CAST (self, gtk_dialog_get_type (), GtkDialog), _tmp5_);
	result = _tmp6_;
	return result;
}


static GObject * granite_widgets_pop_over_constructor (GType type, guint n_construct_properties, GObjectConstructParam * construct_properties) {
	GObject * obj;
	GObjectClass * parent_class;
	GraniteWidgetsPopOver * self;
	GdkScreen* _tmp0_;
	GdkVisual* _tmp1_;
	GtkStyleContext* _tmp2_;
	GtkStyleContext* _tmp3_;
	GdkScreen* _tmp4_;
	GtkCssProvider* _tmp5_;
	GtkCssProvider* _tmp6_;
	parent_class = G_OBJECT_CLASS (granite_widgets_pop_over_parent_class);
	obj = parent_class->constructor (type, n_construct_properties, construct_properties);
	self = G_TYPE_CHECK_INSTANCE_CAST (obj, GRANITE_WIDGETS_TYPE_POP_OVER, GraniteWidgetsPopOver);
	_tmp0_ = gtk_window_get_screen ((GtkWindow*) self);
	_tmp1_ = gdk_screen_get_rgba_visual (_tmp0_);
	gtk_widget_set_visual ((GtkWidget*) self, _tmp1_);
	_tmp2_ = gtk_widget_get_style_context ((GtkWidget*) self);
	gtk_style_context_add_class (_tmp2_, GRANITE_STYLE_CLASS_POPOVER);
	_tmp3_ = gtk_widget_get_style_context ((GtkWidget*) self);
	gtk_style_context_add_class (_tmp3_, GRANITE_STYLE_CLASS_COMPOSITED);
	_tmp4_ = gtk_window_get_screen ((GtkWindow*) self);
	_tmp5_ = granite_widgets_utils_set_theming_for_screen (_tmp4_, GRANITE_WIDGETS_POP_OVER_POPOVER_STYLESHEET, GTK_STYLE_PROVIDER_PRIORITY_APPLICATION);
	_tmp6_ = _tmp5_;
	_g_object_unref0 (_tmp6_);
	gtk_widget_set_app_paintable ((GtkWidget*) self, TRUE);
	gtk_window_set_decorated ((GtkWindow*) self, FALSE);
	gtk_window_set_resizable ((GtkWindow*) self, FALSE);
	gtk_window_set_position ((GtkWindow*) self, GTK_WIN_POS_NONE);
	gtk_window_set_type_hint ((GtkWindow*) self, GDK_WINDOW_TYPE_HINT_MENU);
	gtk_window_set_skip_pager_hint ((GtkWindow*) self, TRUE);
	gtk_window_set_skip_taskbar_hint ((GtkWindow*) self, TRUE);
	return obj;
}


static void granite_widgets_pop_over_class_init (GraniteWidgetsPopOverClass * klass) {
	GParamSpecInt* _tmp0_;
	GParamSpecInt* _tmp1_;
	GParamSpecInt* _tmp2_;
	GParamSpecInt* _tmp3_;
	GParamSpecInt* _tmp4_;
	GParamSpecInt* _tmp5_;
	GParamSpecInt* _tmp6_;
	GParamSpecInt* _tmp7_;
	GParamSpecInt* _tmp8_;
	GParamSpecInt* _tmp9_;
	granite_widgets_pop_over_parent_class = g_type_class_peek_parent (klass);
	g_type_class_add_private (klass, sizeof (GraniteWidgetsPopOverPrivate));
	((GtkWidgetClass *) klass)->hide = (void (*) (GtkWidget *)) granite_widgets_pop_over_real_hide;
	((GtkWidgetClass *) klass)->show = (void (*) (GtkWidget *)) granite_widgets_pop_over_real_show;
	((GtkWidgetClass *) klass)->map_event = (gboolean (*) (GtkWidget *, GdkEventAny*)) granite_widgets_pop_over_real_map_event;
	((GtkWidgetClass *) klass)->button_press_event = (gboolean (*) (GtkWidget *, GdkEventButton*)) granite_widgets_pop_over_real_button_press_event;
	((GtkWidgetClass *) klass)->button_release_event = (gboolean (*) (GtkWidget *, GdkEventButton*)) granite_widgets_pop_over_real_button_release_event;
	((GtkWidgetClass *) klass)->draw = (gboolean (*) (GtkWidget *, cairo_t*)) granite_widgets_pop_over_real_draw;
	G_OBJECT_CLASS (klass)->constructor = granite_widgets_pop_over_constructor;
	G_OBJECT_CLASS (klass)->finalize = granite_widgets_pop_over_finalize;
	_tmp0_ = g_param_spec_int ("border-radius", "Border radius", "Border radius of the popover", 0, 50, 8, G_PARAM_READABLE);
	_tmp1_ = _tmp0_;
	gtk_widget_class_install_style_property (GTK_WIDGET_CLASS (klass), (GParamSpec*) _tmp1_);
	_g_param_spec_unref0 (_tmp1_);
	_tmp2_ = g_param_spec_int ("border-width", "Border width", "Width of the popover's outer border", 0, 8, 1, G_PARAM_READABLE);
	_tmp3_ = _tmp2_;
	gtk_widget_class_install_style_property (GTK_WIDGET_CLASS (klass), (GParamSpec*) _tmp3_);
	_g_param_spec_unref0 (_tmp3_);
	_tmp4_ = g_param_spec_int ("shadow-size", "Shadow size", "Size of the popover's shadow", 4, 50, 20, G_PARAM_READABLE);
	_tmp5_ = _tmp4_;
	gtk_widget_class_install_style_property (GTK_WIDGET_CLASS (klass), (GParamSpec*) _tmp5_);
	_g_param_spec_unref0 (_tmp5_);
	_tmp6_ = g_param_spec_int ("arrow-height", "Arrow height", "Height of the popover's arrow", 0, 50, 14, G_PARAM_READABLE);
	_tmp7_ = _tmp6_;
	gtk_widget_class_install_style_property (GTK_WIDGET_CLASS (klass), (GParamSpec*) _tmp7_);
	_g_param_spec_unref0 (_tmp7_);
	_tmp8_ = g_param_spec_int ("arrow-width", "Arrow width", "Width of the popover's arrow", 0, 50, 30, G_PARAM_READABLE);
	_tmp9_ = _tmp8_;
	gtk_widget_class_install_style_property (GTK_WIDGET_CLASS (klass), (GParamSpec*) _tmp9_);
	_g_param_spec_unref0 (_tmp9_);
}


static void granite_widgets_pop_over_instance_init (GraniteWidgetsPopOver * self) {
	self->priv = GRANITE_WIDGETS_POP_OVER_GET_PRIVATE (self);
	self->priv->offset = 15.0;
	self->priv->pos = GRANITE_WIDGETS_POP_OVER_POP_POSITION_NONE;
	self->arrow_up = FALSE;
	self->arrow_offset = 35.0;
	self->priv->was_shown = FALSE;
	self->main_buffer = NULL;
	self->priv->old_w = 0;
	self->priv->old_h = 0;
}


static void granite_widgets_pop_over_finalize (GObject * obj) {
	GraniteWidgetsPopOver * self;
	self = G_TYPE_CHECK_INSTANCE_CAST (obj, GRANITE_WIDGETS_TYPE_POP_OVER, GraniteWidgetsPopOver);
	_g_object_unref0 (self->priv->menu);
	_g_object_unref0 (self->priv->hbox);
	_g_object_unref0 (self->priv->abox);
	_g_object_unref0 (self->main_buffer);
	G_OBJECT_CLASS (granite_widgets_pop_over_parent_class)->finalize (obj);
}


/**
 * /!\ Unstable API
 *
 * PopOver widget. It is a Dialog you can attach to a widget, e.g. a button.
 *
 * It is a dialog you can attach to a widget, to make it look
 * more consistent, and easier to understand. e.g. if you need to make a popup
 * after clicking on a button as "Create a new document" to choose the type
 * of the document, a popover is more adapted because you can see which button
 * is related to the button, etc... It is also less agressive than a usual
 * dialog because it doesn't hide a big part of the screen. And it is closed
 * when it lose focus.
 *
 * {{../../doc/images/PopOver.png}}
 *
 */
GType granite_widgets_pop_over_get_type (void) {
	static volatile gsize granite_widgets_pop_over_type_id__volatile = 0;
	if (g_once_init_enter (&granite_widgets_pop_over_type_id__volatile)) {
		static const GTypeInfo g_define_type_info = { sizeof (GraniteWidgetsPopOverClass), (GBaseInitFunc) NULL, (GBaseFinalizeFunc) NULL, (GClassInitFunc) granite_widgets_pop_over_class_init, (GClassFinalizeFunc) NULL, NULL, sizeof (GraniteWidgetsPopOver), 0, (GInstanceInitFunc) granite_widgets_pop_over_instance_init, NULL };
		GType granite_widgets_pop_over_type_id;
		granite_widgets_pop_over_type_id = g_type_register_static (gtk_dialog_get_type (), "GraniteWidgetsPopOver", &g_define_type_info, 0);
		g_once_init_leave (&granite_widgets_pop_over_type_id__volatile, granite_widgets_pop_over_type_id);
	}
	return granite_widgets_pop_over_type_id__volatile;
}



